.PHONY: all install-opensearch uninstall-opensearch configure-opensearch create-service remove-service

# Variáveis
OPENSEARCH_VERSION=2.19.2
SERVICE_NAME=opensearch
PORT=8070
USERNAME=hawk
PASSWORD=pegaAVisao1@
SERVICES_DIR=services

all: install-opensearch configure-opensearch
	@echo "OpenSearch instalado e configurado com sucesso!"
	@echo "Usuário: $(USERNAME)"
	@echo "Senha: $(PASSWORD)"
	@echo "Porta: $(PORT)"
	@echo "Para iniciar os serviços, execute:"
	@echo "  sudo systemctl start opensearch"
	@echo "  sudo systemctl start opensearch-dashboards"
	@echo "Acesse o dashboard em: http://localhost:$(PORT)"

install-opensearch:
	@echo "Instalando OpenSearch..."
	# Instalar dependências necessárias
	apt-get update
	apt-get install -y wget

	# Download e instalação do OpenSearch
	wget https://artifacts.opensearch.org/releases/bundle/opensearch/$(OPENSEARCH_VERSION)/opensearch-$(OPENSEARCH_VERSION)-linux-x64.deb
	dpkg -i opensearch-$(OPENSEARCH_VERSION)-linux-x64.deb
	rm opensearch-$(OPENSEARCH_VERSION)-linux-x64.deb

	# Download e instalação do OpenSearch Dashboards
	wget https://artifacts.opensearch.org/releases/bundle/opensearch-dashboards/$(OPENSEARCH_VERSION)/opensearch-dashboards-$(OPENSEARCH_VERSION)-linux-x64.deb
	dpkg -i opensearch-dashboards-$(OPENSEARCH_VERSION)-linux-x64.deb
	rm opensearch-dashboards-$(OPENSEARCH_VERSION)-linux-x64.deb

configure-opensearch:
	@echo "Configurando OpenSearch..."
	# Configurar opensearch.yml
	sed -i 's/network.host: 0.0.0.0/network.host: 0.0.0.0/' /etc/opensearch/opensearch.yml
	sed -i 's/http.port: 9200/http.port: $(PORT)/' /etc/opensearch/opensearch.yml
	echo "plugins.security.disabled: false" >> /etc/opensearch/opensearch.yml
	echo "discovery.type: single-node" >> /etc/opensearch/opensearch.yml
	echo "plugins.security.ssl.http.enabled: false" >> /etc/opensearch/opensearch.yml
	echo "plugins.security.ssl.transport.enabled: false" >> /etc/opensearch/opensearch.yml

	# Configurar opensearch-dashboards.yml
	sed -i 's/server.host: "localhost"/server.host: "0.0.0.0"/' /etc/opensearch-dashboards/opensearch_dashboards.yml
	sed -i 's/server.port: 5601/server.port: $(PORT)/' /etc/opensearch-dashboards/opensearch_dashboards.yml
	sed -i 's/opensearch.hosts: \["http:\/\/localhost:9200"\]/opensearch.hosts: \["http:\/\/localhost:$(PORT)"\]/' /etc/opensearch-dashboards/opensearch_dashboards.yml
	echo "opensearch_security.ssl.verification_mode: none" >> /etc/opensearch-dashboards/opensearch_dashboards.yml
	echo "opensearch.ssl.verificationMode: none" >> /etc/opensearch-dashboards/opensearch_dashboards.yml

	# Configurar credenciais
	cd /usr/share/opensearch/plugins/opensearch-security/tools && \
	./hash.sh -p $(PASSWORD) > hashed_password.txt && \
	HASHED_PASSWORD=$$(cat hashed_password.txt) && \
	sed -i "s/admin:admin/$(USERNAME):$$HASHED_PASSWORD/" /etc/opensearch/opensearch-security/internal_users.yml

	# Ajustar permissões
	chown -R opensearch:opensearch /etc/opensearch
	chown -R opensearch-dashboards:opensearch-dashboards /etc/opensearch-dashboards

	# Reiniciar serviços
	systemctl restart opensearch
	systemctl restart opensearch-dashboards

uninstall-opensearch:
	@echo "Desinstalando OpenSearch..."
	systemctl stop opensearch || true
	systemctl stop opensearch-dashboards || true
	apt-get remove -y opensearch opensearch-dashboards
	apt-get purge -y opensearch opensearch-dashboards
	rm -rf /etc/opensearch
	rm -rf /etc/opensearch-dashboards
	rm -rf /var/lib/opensearch
	rm -rf /var/lib/opensearch-dashboards 