.PHONY: all install-opensearch uninstall-opensearch configure-opensearch create-service remove-service

# Variáveis
OPENSEARCH_VERSION=2.19.2
SERVICE_NAME=opensearch
PORT=8070
USERNAME=hawk
PASSWORD=pegandoAVisao
SERVICES_DIR=services

all: install-opensearch configure-opensearch create-service
	@echo "OpenSearch instalado e configurado com sucesso!"
	@echo "Usuário: $(USERNAME)"
	@echo "Senha: $(PASSWORD)"
	@echo "Porta: $(PORT)"
	@echo "Para iniciar os serviços, execute:"
	@echo "  sudo systemctl start $(SERVICE_NAME)"
	@echo "  sudo systemctl start $(SERVICE_NAME)-dashboards"
	@echo "Acesse o dashboard em: http://localhost:$(PORT)"

install-opensearch:
	@echo "Instalando OpenSearch..."
	# Download e instalação do OpenSearch
	wget https://artifacts.opensearch.org/releases/bundle/opensearch/$(OPENSEARCH_VERSION)/opensearch-$(OPENSEARCH_VERSION)-linux-x64.tar.gz
	tar -xzf opensearch-$(OPENSEARCH_VERSION)-linux-x64.tar.gz
	rm opensearch-$(OPENSEARCH_VERSION)-linux-x64.tar.gz
	mv opensearch-$(OPENSEARCH_VERSION) opensearch

	# Download e instalação do OpenSearch Dashboards
	wget https://artifacts.opensearch.org/releases/bundle/opensearch-dashboards/$(OPENSEARCH_VERSION)/opensearch-dashboards-$(OPENSEARCH_VERSION)-linux-x64.tar.gz
	tar -xzf opensearch-dashboards-$(OPENSEARCH_VERSION)-linux-x64.tar.gz
	rm opensearch-dashboards-$(OPENSEARCH_VERSION)-linux-x64.tar.gz
	mv opensearch-dashboards-$(OPENSEARCH_VERSION) opensearch-dashboards

configure-opensearch:
	@echo "Configurando OpenSearch..."
	# Configurar opensearch.yml
	sed -i 's/network.host: 0.0.0.0/network.host: localhost/' opensearch/config/opensearch.yml
	sed -i 's/http.port: 9200/http.port: $(PORT)/' opensearch/config/opensearch.yml
	echo "plugins.security.disabled: false" >> opensearch/config/opensearch.yml
	echo "discovery.type: single-node" >> opensearch/config/opensearch.yml

	# Configurar opensearch-dashboards.yml
	sed -i 's/server.port: 5601/server.port: $(PORT)/' opensearch-dashboards/config/opensearch-dashboards.yml
	sed -i 's/opensearch.hosts: \["http:\/\/localhost:9200"\]/opensearch.hosts: \["http:\/\/localhost:$(PORT)"\]/' opensearch-dashboards/config/opensearch-dashboards.yml

	# Configurar credenciais
	cd opensearch/plugins/opensearch-security/tools && \
	./hash.sh -p $(PASSWORD) > hashed_password.txt && \
	HASHED_PASSWORD=$$(cat hashed_password.txt) && \
	sed -i "s/admin:admin/$(USERNAME):$$HASHED_PASSWORD/" ../../../config/opensearch-security/internal_users.yml

create-service:
	@echo "Criando serviço do OpenSearch..."
	# Substituir variáveis nos arquivos de serviço
	sed "s|\$${USER}|$${USER}|g; s|\$${PWD}|$${PWD}|g" $(SERVICES_DIR)/$(SERVICE_NAME).service > /etc/systemd/system/$(SERVICE_NAME).service
	sed "s|\$${USER}|$${USER}|g; s|\$${PWD}|$${PWD}|g" $(SERVICES_DIR)/$(SERVICE_NAME)-dashboards.service > /etc/systemd/system/$(SERVICE_NAME)-dashboards.service

	# Recarregar daemon e habilitar serviços
	systemctl daemon-reload
	systemctl enable $(SERVICE_NAME)
	systemctl enable $(SERVICE_NAME)-dashboards

remove-service:
	@echo "Removendo serviços do OpenSearch..."
	systemctl stop $(SERVICE_NAME) || true
	systemctl stop $(SERVICE_NAME)-dashboards || true
	systemctl disable $(SERVICE_NAME) || true
	systemctl disable $(SERVICE_NAME)-dashboards || true
	rm -f /etc/systemd/system/$(SERVICE_NAME).service
	rm -f /etc/systemd/system/$(SERVICE_NAME)-dashboards.service
	systemctl daemon-reload

uninstall-opensearch: remove-service
	@echo "Desinstalando OpenSearch..."
	rm -rf opensearch
	rm -rf opensearch-dashboards 