.PHONY: install-loki configure-loki setup-loki

install: install-loki configure-loki

install-loki:
	@echo "Setting up Grafana repository..."
	sudo mkdir -p /etc/apt/keyrings/
	wget -q -O - https://apt.grafana.com/gpg.key | sudo gpg --dearmor > /etc/apt/keyrings/grafana.gpg
	echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
	@echo "Updating package lists..."
	sudo apt-get update
	@echo "Installing Loki and Promtail..."
	sudo apt-get install -y loki promtail

configure-loki:
	@echo "Creating Loki configuration directory..."
	sudo mkdir -p /etc/loki
	@echo "Copying Loki configuration..."
	sudo cp ../loki-config.yaml /etc/loki/config.yaml
	@echo "Creating data directories..."
	sudo mkdir -p /tmp/loki/chunks
	@echo "Setting permissions..."
	sudo chown -R loki:loki /tmp/loki
	@echo "Restarting Loki service..."
	sudo systemctl restart loki 

clean:
	@echo "Stopping Loki service..."
	sudo systemctl stop loki
	@echo "Removing Loki configuration..."
	sudo rm -rf /etc/loki
	sudo apt-get remove -y loki promtail
	@echo "Removing Loki data directory..."
	sudo rm -rf /tmp/loki
	@echo "Loki services uninstalled successfully"
